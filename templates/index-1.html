<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Voice Recorder</title>
</head>
<body>
    <button id="recordButton">Start Recording</button>

    <div id = "question" style="display: none"> Replay your question
        <audio id="audioPlayer" controls></audio>
    </div>

    <div id = "answer" style="display: none"> Answer from GPT
        <audio id="musicPlayer" controls></audio>
    </div>

<script src="https://cdn.jsdelivr.net/gh/otalk/hark@latest/hark.bundle.js"></script>
<script>
    let recordButton = document.getElementById('recordButton');
    let audioPlayer = document.getElementById('audioPlayer');
    let musicPlayer = document.getElementById('musicPlayer');
    let question = document.getElementById('question');
    let answer = document.getElementById('answer');
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;
    let lastTimeUpdate = 0;
    let stuckTimeout = null;
    const STUCK_TIMEOUT_MS = 2000;

    recordButton.onclick = function() {
        if (!isRecording) {
            navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();

                // hark setup
                let options = {};
                let speechEvents = hark(stream, options);

                let timeout;
                speechEvents.on('stopped_speaking', function() {
                    timeout = setTimeout(function() {
                        if (mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                            isRecording = false;
                            recordButton.textContent = 'Start Recording';
                        }
                    }, 3000);  // 3 seconds of silence
                });

                speechEvents.on('speaking', function() {
                    clearTimeout(timeout);
                });

                mediaRecorder.ondataavailable = function(e) {
                    recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = function() {
                    let formData = new FormData();
                    let blob = new Blob(recordedChunks, {type: 'audio/webm'});
                    formData.append('audio_data', blob);
                    fetch('/record', {
                        method: 'POST',
                        body: formData
                    }).then(response => {
                        return response.blob();
                    }).then(blob => {
                        let url = URL.createObjectURL(blob);
                        audioPlayer.src = url;
                        audioPlayer.play();
                        question.style.display = 'block';
                    });
                    recordedChunks = [];
                };
            });
            recordButton.textContent = 'Stop Recording';
            isRecording = true;
        } else {
            mediaRecorder.stop();
            recordButton.textContent = 'Start Recording';
            isRecording = false;
        }
    }

            // Play music after recorded audio has finished playing
        audioPlayer.onended = function() {
            fetch('/music_play', {
                method: 'GET'
            }).then(response => {
                return response.json();
            }).then(data => {
                question.style.display = 'none';
                musicPlayer.src = data.url;
                musicPlayer.play();
                answer.style.display = 'block';
            });
        }

        // Refresh the page after the music has finished playing
        musicPlayer.onended = function() {
            location.reload();
            // answer.style.display = 'none';
            // startRecording();
        }

                // Refresh the page if an error occurs while playing the music
        musicPlayer.onerror = function() {
            location.reload();
        }
            // Stop playing if the music is stuck or blocked
        musicPlayer.ontimeupdate = function() {
            if (musicPlayer.currentTime === lastTimeUpdate) {
                if (!stuckTimeout) {
                    stuckTimeout = setTimeout(function() {
                        musicPlayer.pause();
                        location.reload();
                        stuckTimeout = null;
                    }, STUCK_TIMEOUT_MS);
                }
            } else {
                clearTimeout(stuckTimeout);
                stuckTimeout = null;
            }

            lastTimeUpdate = musicPlayer.currentTime;
        }

</script>

</body>
</html>


<!--
    let lastTimeUpdate = 0;
    let stuckTimeout = null;
    const STUCK_TIMEOUT_MS = 2000;
            // Stop playing if the music is stuck or blocked
        musicPlayer.ontimeupdate = function() {
            if (musicPlayer.currentTime === lastTimeUpdate) {
                if (!stuckTimeout) {
                    stuckTimeout = setTimeout(function() {
                        musicPlayer.pause();
                        location.reload();
                        stuckTimeout = null;
                    }, STUCK_TIMEOUT_MS);
                }
            } else {
                clearTimeout(stuckTimeout);
                stuckTimeout = null;
            }

            lastTimeUpdate = musicPlayer.currentTime;
        }

!-->

