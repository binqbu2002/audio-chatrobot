<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Voice Recorder</title>
</head>
<body>
    <button id="recordButton">Start Recording</button>

    <div id = "question" style="display: none"> Replay your question
        <audio id="audioPlayer" controls></audio>
    </div>

    <div id = "answer" style="display: none"> Answer from GPT
        <audio id="musicPlayer" controls></audio>
    </div>
<!--    <audio id="audioPlayer" controls style="display: none;">Replay your question</audio>-->
<!--    <audio id="musicPlayer" controls style="display: none;">GPT respond</audio>-->

<!--        <audio id="audio" controls style="display: none;"></audio>-->
<!--    <audio id="music" controls style="display: none;"></audio>-->

    <script>
        let recordButton = document.getElementById('recordButton');
        let audioPlayer = document.getElementById('audioPlayer');
        let musicPlayer = document.getElementById('musicPlayer');
        let question = document.getElementById('question');
        let answer = document.getElementById('answer');
        let mediaRecorder;
        let recordedChunks = [];

        recordButton.onclick = function() {
            if (recordButton.textContent === 'Start Recording') {
                navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();

                    mediaRecorder.ondataavailable = function(e) {
                        recordedChunks.push(e.data);
                    };

                    mediaRecorder.onstop = function() {
                        let formData = new FormData();
                        let blob = new Blob(recordedChunks, {type: 'audio/webm'});
                        formData.append('audio_data', blob);
                        fetch('/record', {
                            method: 'POST',
                            body: formData
                        }).then(response => {
                            return response.blob();
                        }).then(blob => {
                            let url = URL.createObjectURL(blob);
                            // let a = document.createElement('a');
                            // a.href = url;
                            // a.download = 'recorded_audio.wav';
                            // a.click();
                            audioPlayer.src = url;
                            audioPlayer.play();
                            question.style.display = 'block';
                        });
                        recordedChunks = [];
                    };
                });
                recordButton.textContent = 'Stop Recording';
            } else {
                mediaRecorder.stop();
                recordButton.textContent = 'Start Recording';
            }
        }

        // Play music after recorded audio has finished playing
        audioPlayer.onended = function() {
            fetch('/music_play', {
                method: 'GET'
            }).then(response => {
                return response.json();
            }).then(data => {
                question.style.display = 'none';
                musicPlayer.src = data.url;
                musicPlayer.play();
                answer.style.display = 'block';
            });
        }

        // Refresh the page after the music has finished playing
        musicPlayer.onended = function() {
            location.reload();
        }

                // Refresh the page if an error occurs while playing the music
        musicPlayer.onerror = function() {
            location.reload();
        }
    </script>
</body>
</html>
