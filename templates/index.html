<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recorder</title>
</head>
<body>
    <button id="record">Record</button>
    <button id="stop" disabled>Stop</button>
    <button id="stop-all">Stop All</button>
    <audio id="audio" controls style="display: none;"></audio>
    <audio id="music" controls style="display: none;"></audio>
    <script>
         const recordButton = document.getElementById('record');
        const stopButton = document.getElementById('stop');
        const stopAllButton = document.getElementById('stop-all');
        const audioElement = document.getElementById('audio');
        const musicElement = document.getElementById('music');

        let mediaRecorder;
        let chunks = [];
        let silenceDetector;
        let allowLoop = true;

        const startRecording = () => {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const audioContext = new AudioContext();
                    const source = audioContext.createMediaStreamSource(stream);
                    silenceDetector = audioContext.createScriptProcessor(4096, 1, 1);

                    let silenceDuration = 0;
                    let previousTimestamp = new Date().getTime();
                    let recordingStarted = false;

                    silenceDetector.onaudioprocess = (e) => {
                        const buffer = e.inputBuffer.getChannelData(0);
                        let maxAmplitude = 0;

                        for (let i = 0; i < buffer.length; i++) {
                            maxAmplitude = Math.max(maxAmplitude, Math.abs(buffer[i]));
                        }

                        const silenceThreshold = 0.01;
                        const isSilent = maxAmplitude < silenceThreshold;

                        if (!recordingStarted && !isSilent) {
                            recordingStarted = true;
                        }

                        if (recordingStarted) {
                            const currentTimestamp = new Date().getTime();
                            silenceDuration = isSilent ? (silenceDuration + (currentTimestamp - previousTimestamp)) : 0;
                            previousTimestamp = currentTimestamp;

                            if (silenceDuration >= 2000) {
                                stopButton.click();
                            }
                        }
                    };

                    source.connect(silenceDetector);
                    silenceDetector.connect(audioContext.destination);

                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();

                    mediaRecorder.ondataavailable = e => {
                        chunks.push(e.data);
                    };

                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/wav' });
                        chunks = [];
                        let formData = new FormData();
                        formData.append('audio_data', blob);

                        fetch('/upload', {
                            method: 'POST',
                            body: formData
                        }).then(() => {
                            const timestamp = new Date().getTime();
                            audioElement.src = `/audio/audio.wav?${timestamp}`;
                            audioElement.load();
                            audioElement.play();
                            recordButton.disabled = false;
                            stopButton.disabled = true;
                        });
                    };

                    recordButton.disabled = true;
                    stopButton.disabled = false;
                });
        };

       recordButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', () => {
            mediaRecorder.stop();
            silenceDetector.disconnect();
        });

                stopAllButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                silenceDetector.disconnect();
            }
            if (!audioElement.paused) {
                audioElement.pause();
            }
            if (!musicElement.paused) {
                musicElement.pause();
            }
            allowLoop = false;
        });

        audioElement.addEventListener('ended', () => {
            if (allowLoop) {
                fetch('/fetch_music')
                    .then(response => response.blob())
                    .then(blob => {
                        musicElement.src = URL.createObjectURL(blob);
                        musicElement.load();
                        musicElement.play();
                        musicElement.style.display = 'block';
                    });
            }
        });

        musicElement.addEventListener('ended', () => {
            if (allowLoop) {
                startRecording();
            }
        });


    </script>
</body>
</html>
